## 1. 개요

전통적인 수동 배포 방식은 작업자의 숙련도에 의존하며, 빌드 환경과 운영 환경의 불일치로 인한 잠재적 장애 위험을 내포하고 있습니다. 본 프로젝트는 이러한 불확실성을 제거하기 위해 Jenkins 기반의 자동화된 CI/CD 파이프라인을 설계하였습니다.

본 시스템은 CI와 CD단계를 물리적, 논리적으로 분리하여 다음을 달성하는 것을 목적으로 합니다.

- **빌드 무결성 보장:** 소스코드의 품질 검증과 빌드 과정을 자동화하여, 운영 환경에 배포되는 아티팩트(Artifact)의 신뢰성을 확보합니다.
- **배포 안정성 확보:** Blue/Green 배포 전략을 통해 서비스 중단 시간을 제로화하고, 장애 발생 시 즉각적인 롤백이 가능한 구조를 구현합니다.
- **환경 격리:** 빌드 결과물(Artifact)을 단일 단위로 관리하여, "빌드 성공"과 "배포 성공"의 책임을 명확히 분리합니다.

이를 통해 개발자는 코드 작성에만 집중하며, 배포 과정에서 발생할 수 있는 인적 오류(Human Error)를 시스템적으로 차단하였습니다.

---
## 2. 기능 요구사항
본 파이프라인은 단순한 자동화를 넘어, 조직의 개발 표준 준수와 운영 통제권을 확보하기 위해 다음과 같은 세부 요구사항을 충족하도록 설계되었습니다.

**코드 품질 자동 검증**
모든 코드는 병합 및 빌드 이전에 정적 분석을 통과해야 합니다. ESLint를 통한 스타일 검사, TypeScript 타입 무결성 검증, 그리고 소스코드 내 하드코딩된 Secret 및 취약한 의존성 버전을 사전에 탐지하여, 보안 위협이 포함된 코드가 아티팩트로 생성되는 것을 원천 차단합니다.

**불변 아티팩트 기반 배포**
CI 단계에서 생성된 빌드 결과물은 배포 가능한 단일 단위로 취급됩니다. CD 단계에서는 소스코드를 다시 빌드하지 않으며, 검증된 아티팩트를 그대로 사용함으로써 "어제 빌드된 결과물이 오늘 배포되어도 동일함"을 보장합니다.

**승인 기반 배포 통제** 
개발 환경에서의 빈번한 배포가 운영 환경의 불안정성으로 이어지는 것을 방지하기 위해, 운영 배포 직전 명시적인 승인 절차를 둡니다. 이를 통해 배포 시점을 운영자가 통제할 수 있도록 합니다.

**무중단 배포 및 자동화된 롤백** 
서비스 가용성을 유지하기 위해 Nginx와 이중화된 포트(Blue/Green)를 활용합니다. 신규 버전의 Health Check가 실패할 경우 트래픽 전환을 수행하지 않음으로써 장애 전파를 방지합니다.

---
## 3. 아키텍처 및 파이프라인 흐름
Jenkins를 중앙 오케스트레이터로 사용하여 Git 저장소의 변경 사항을 감지하고, 빌드 서버와 운영 서버 간의 아티팩트 흐름을 제어합니다.

### 3.1 CI (Continuous Integration) 파이프라인
CI는 "코드의 유효성 검증"과 "배포 가능한 아티팩트 생성"을 담당합니다.
1. **Checkout:** Git 저장소로부터 최신 코드를 격리된 워크스페이스로 가져옵니다.
2. **Static Analysis:** 린트(Lint), 타입 체크, 보안 스캔을 병렬적으로 수행합니다.
3. **Build:** Nuxt 애플리케이션 빌드를 수행하여 정적 파일 및 서버 스크립트를 생성합니다.
4. **Packaging:** 빌드 결과물을 `build.tar.gz` 형태로 압축하고 고유 빌드 번호를 태깅합니다.
5. **Archive:** 생성된 아티팩트를 Jenkins 내부 저장소 또는 별도 아티팩트 저장소에 보관합니다.

### 3.2 CD (Continuous Delivery) 파이프라인
CD는 "검증된 아티팩트의 안전한 서비스 반영"을 담당합니다.
1. **Approval:** 운영 배포 승인 대기 상태로 진입합니다.
2. **Fetch Artifact:** 지정된 빌드 번호의 아티팩트를 운영 서버로 전송합니다.
3. **Deploy (Blue/Green):** 비활성 포트에서 신규 버전을 구동하고 Health Check를 수행합니다.
4. **Traffic Switch:** Nginx 설정을 변경하여 트래픽을 신규 인스턴스로 전환합니다.

---
## 4. 핵심 컴포넌트 명세
CI/CD 아키텍처를 구성하는 핵심 컴포넌트들의 역할과 데이터 구조를 정의합니다.

### 4.1 배포 아티팩트 (Artifact)
CI 파이프라인의 최종 산출물이며, CD 단계의 유일한 입력값(Input)입니다. 환경별 설정 파일은 아티팩트 내부에 포함되지 않고, 배포 시점의 서버 환경 변수 또는 주입된 설정 파일을 따릅니다.

|항목|구분|설명|
|:--|:--|:--|
|**Name Format**|명명 규칙|`project-name-v{build_number}.tar.gz`|
|**Contents**|포함 내용|`.output/` (Nuxt 빌드 결과물), `package.json`, `ecosystem.config.js`|
|**Retention**|보관 정책|최근 10개 빌드 보관 (롤백 용도)|

### 4.2 Blue/Green 인스턴스 구조
단일 서버 내에서 포트 기반으로 논리적인 Blue/Green 환경을 구성합니다. Nginx는 Upstream 설정을 통해 트래픽을 제어하는 로드밸런서 역할을 수행합니다.

|항목|Blue Set|Green Set|비고|
|:--|:--|:--|:--|
|**Port**|`3000`|`3001`|PM2 프로세스 포트|
|**PM2 Name**|`app-blue`|`app-green`|프로세스 식별자|
|**Status**|Active / Standby|Standby / Active|배포 시마다 역할 교대|

### 4.3 검증 정책 (Quality Gates)
CI 단계에서 수행되는 자동 검증 항목입니다. 하나라도 위반될 경우 빌드는 즉시 실패(Fail) 처리되며 아티팩트는 생성되지 않습니다.

|검사 항목|도구|목적|실패 기준|
|:--|:--|:--|:--|
|**Linting**|ESLint|코드 스타일 및 잠재적 오류 탐지|Error 레벨 1개 이상|
|**Type Check**|tsc|컴파일 단계의 타입 안정성 확보|컴파일 에러 발생 시|
|**Audit**|npm audit|의존성 패키지의 보안 취약점 검사|High 등급 이상 취약점 발견 시|
|**Secret Scan**|GitLeaks|소스 내 하드코딩된 Key/Password 탐지|패턴 매칭 성공 시|

---

## 5. 라이프사이클별 흐름
본 장에서는 정상 배포, 무중단 전환, 롤백 시나리오에 따른 상세 프로세스를 설명합니다.

### 5.1 정상 배포 프로세스 (Deploy)

1. **Target 식별:** 현재 구동 중인 포트(Active)를 확인하여, 배포 대상 포트(Standby)를 결정합니다. (예: 현재 3000이면 3001이 대상)
2. **Clean & Extract:** 배포 대상 디렉토리를 초기화하고, 전송된 아티팩트 압축을 해제합니다.
3. **Install Dependencies:** `npm ci --production`을 수행하여 런타임 의존성을 설치합니다.
4. **Start Application:** PM2를 통해 신규 인스턴스를 구동합니다.
5. **Health Check:** `curl localhost:{target_port}/health`를 주기적으로 호출하여 응답(200 OK)을 확인합니다. (최대 60초 대기)
6. **Switch Traffic:** Nginx 설정을 변경하고 `nginx -s reload`를 수행하여 트래픽을 신규 포트로 전환합니다.
7. **Terminate Old:** 기존 구동 중이던 인스턴스를 안전하게 종료(Graceful Shutdown)합니다.

### 5.2 롤백 프로세스 (Rollback)

배포 직후 또는 운영 중 심각한 장애 발견 시, 이전 안정 버전으로 복구하는 절차입니다.

1. **Artifact Selection:** Jenkins 또는 저장소에서 이전 성공 빌드 번호의 아티팩트를 선택합니다.
2. **Redeploy:** 선택된 아티팩트를 사용하여 5.1의 배포 프로세스를 동일하게 수행합니다.
3. **Fast Recovery:** 만약 이전 버전의 프로세스가 아직 종료되지 않은 상태(배포 직후)라면, Nginx 전환만으로 즉시 복구(1초 이내)가 가능합니다.

---

## 6. 장애 대응 전략

배포 과정 또는 운영 중 발생할 수 있는 예외 상황에 대한 시스템의 대응 방식을 정의합니다.

### 6.1 배포 중 Health Check 실패

신규 버전 코드가 런타임 에러로 인해 기동되지 않거나, Health Check API가 200을 반환하지 않는 경우입니다.

- **대응:** Nginx 트래픽 전환(Reload)을 수행하지 않습니다.
- **결과:** 기존 서비스(Active)가 계속 트래픽을 처리하므로 사용자에게는 장애가 노출되지 않습니다.
- **후속:** 배포 파이프라인은 실패(Failure)로 마킹되며, 개발자에게 알림이 발송됩니다.

### 6.2 아티팩트 손상 또는 전송 실패

네트워크 불안정으로 인해 아티팩트 파일이 손상된 경우입니다.

- **대응:** 아티팩트 압축 해제 단계(`tar -xzf`)에서 오류가 감지되면 배포 스크립트는 즉시 중단됩니다.
- **결과:** 기존 시스템 상태가 유지됩니다.

---

## 7. 트레이드오프

본 아키텍처 채택에 따른 이점과 감수해야 할 비용을 기술합니다.

### 장점 (Pros)

- **운영 안정성:** 검증된 코드만 배포되며, 배포 중 서비스 중단이 발생하지 않습니다.
- **책임 소재 명확화:** 빌드 오류(개발자 책임)와 배포 오류(운영/환경 책임)가 단계별로 분리됩니다.
- **복구 속도:** 아티팩트 기반이므로 소스코드 Revert나 재빌드 없이 즉시 이전 버전으로 교체가 가능합니다.

### 단점 (Cons)

- **리소스 사용량 증가:** Blue/Green 배포 시점에는 두 배의 서버 리소스(메모리 등)가 일시적으로 필요합니다.
- **초기 구성 비용:** Jenkins Pipeline Script(Groovy), Nginx 설정, 배포 스크립트 작성 등 초기 엔지니어링 비용이 발생합니다.
- **빌드 시간:** 품질 검증 단계가 추가됨에 따라 단순 배포 대비 CI 소요 시간이 증가합니다.