DynamicBoardSqlBuilder가 필드 정의 메타데이터를 기반으로 INSERT, SELECT, UPDATE, DELETE SQL을 런타임에 조합하고, NamedParameterJdbcTemplate으로 실행합니다. SQL Injection 방지를 위해 모든 컬럼명과 타입은 화이트리스트 검증을 거치며, 사용자 입력값은 파라미터 바인딩으로만 전달합니다. 테이블 분리를 통해 게시판별 데이터 규모가 관리 가능한 수준으로 유지되어 단일 테이블 20만 건 병목이 해소되었고, 각 테이블에 최적화된 인덱스를 독립 적용할 수 있게 되었습니다.

---

1단계로, LoginLogAspect가 인증 서비스의 로그인 성공 및 실패를 AOP로 감지하여, IP, 타임스탬프, 사용자 정보를 비동기 스레드 풀(core 2, max 8)로 로그인 로그 테이블에 JDBC 배치 기록합니다. 2단계(설계 완료)로, 전체 CRUD 감사를 위해 Redis Streams 기반 비동기 파이프라인을 설계했습니다. AOP 기반 감사 Aspect가 서비스 레이어의 CREATE, UPDATE, DELETE 반환을 감지하여 Redis XADD로 감사 이벤트를 발행하고, Consumer Group이 배치로 소비하여 감사 테이블에 기록하는 구조입니다. 비동기 JDBC 직접 기록 대비 Redis Streams를 선택한 이유는, CRUD 감사 이벤트는 로그인보다 빈도가 수십 배 높아 CMS DB에 직접 쓰기 부하를 주면 핵심 트랜잭션 성능에 영향을 주기 때문입니다. Redis Streams는 순서 보장, Consumer Group 배치 소비, 백프레셔를 제공하면서도 Kafka 대비 운영 복잡도가 낮습니다.Redis Streams는 Redis 장애 시 감사 이벤트가 유실될 수 있으나, Redis AOF 영속화와 MINID 기반 트리밍으로 완화합니다. 향후 감사 데이터가 대규모로 증가하면 Kafka로 전환할 수 있도록, 이벤트 스키마(action, entityType, entityId, userId, timestamp, diff)를 Kafka 호환으로 설계해두었습니다.

---

같은 깊이의 노드를 한 번에 배치 저장하고 pathId를 CONCAT 쿼리로 일괄 갱신합니다. 권한 캐시 무효화 시에는 pathId 접두사로 해당 노드의 모든 하위 캐시를 cascade 삭제합니다.


---

메뉴 트리의 권한은 상위 노드에서 하위 노드로 상속되는 구조이므로, 특정 메뉴에 대한 권한을 해소하려면 해당 노드부터 루트까지 전체 조상 체인을 탐색해야 합니다. 기존 구조는 재귀 쿼리가 필수였고, 메뉴 깊이가 4단계 이상인 경우 조회 시간이 200ms를 초과했습니다. 또한 메뉴 동기화 시 DFS 방식으로 트리를 순회하여 노드 수에 비례한 개별 저장 호출이 발생하고, 코드 가독성도 떨어졌습니다.

pathId(dot path) 필드를 도입하여 메뉴의 전체 경로를 문자열(예: "1.3.8")로 기록합니다. 이를 통해 조상 조회는 문자열 분할 한 번으로, 하위 노드 조회는 LIKE 접두사 쿼리 한 번으로 처리됩니다. 권한 해소 시 pathId를 분할하여 얻은 조상 ID 목록으로 단일 쿼리(findAllByMenuIds)를 수행하고, 결과를 거리(distance) 기반 TreeMap에 정렬하여 가까운 조상의 권한이 우선 적용되도록 합니다. 사용자별 권한(userIdx)이 역할 기반 권한(userLevel)보다 우선하는 이중 기준으로 해소합니다. Redis 캐싱은 전체 권한을 하나의 키에 담지 않고, 메뉴 노드별로 분리(perm:menu:{menuId})하여 캐시 적중 시 단일 GET으로 해소가 완료됩니다. 24시간 TTL에 슬라이딩 갱신을 적용하여 활성 메뉴의 캐시 유지율을 높였습니다. 메뉴 동기화는 DFS 재귀에서 BFS 레벨 순회로 전환하여, 같은 깊이의 노드를 한 번에 배치 저장(saveAll)하고 pathId를 CONCAT 쿼리로 일괄 갱신합니다. 권한 캐시 무효화 시에는 pathId 접두사로 해당 노드의 모든 하위 캐시를 cascade 삭제합니다.

그 결과, 재귀 쿼리 제거와 단일 쿼리 조상 조회로 권한 해소 쿼리 수가 75% 감소하고, Redis 노드별 캐싱으로 응답 속도가 20ms 이하로 10배 이상 개선되었습니다. BFS 전환으로 메뉴 동기화 시 DB 호출 횟수가 노드 수 비례에서 트리 깊이 비례로 줄어들고, 레벨 단위 처리 구조가 코드 가독성을 높였습니다.

---
